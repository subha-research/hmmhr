var ze=Object.defineProperty;var be=Object.getOwnPropertySymbols;var je=Object.prototype.hasOwnProperty,Ie=Object.prototype.propertyIsEnumerable;var ge=(i,n,e)=>n in i?ze(i,n,{enumerable:!0,configurable:!0,writable:!0,value:e}):i[n]=e,Y=(i,n)=>{for(var e in n||(n={}))je.call(n,e)&&ge(i,e,n[e]);if(be)for(var e of be(n))Ie.call(n,e)&&ge(i,e,n[e]);return i};var k=(i,n,e)=>new Promise((p,h)=>{var F=r=>{try{b(e.next(r))}catch(B){h(B)}},l=r=>{try{b(e.throw(r))}catch(B){h(B)}},b=r=>r.done?p(r.value):Promise.resolve(r.value).then(F,l);b((e=e.apply(i,n)).next())});import{N as j,ac as S,a9 as Te,i as We,r as C,c as N,w as xe,a1 as He,a8 as Me,a as Xe,e as Ye,f as y,j as u,a3 as T,k as v,x as m,z,l as w,q as o,v as Ge,t as f,af as ke,a5 as V,al as Je,F as A,H as G,I as _e,am as Ke,an as Qe,ae as Fe,ab as De,a7 as Ze,n as _,y as le,ao as et}from"./frappe-ui-XXN5389g.js";import Ce from"./FormField-BpF4IXAT.js";import Ve from"./FileUploaderView-BFlUUILK.js";import{u as tt,W as lt,g as ot}from"./workflow-B8q7fBbJ.js";import{f as Se}from"./formatters-DKvews8N.js";import"./Link-DllPwrQU.js";import"./index-CbDAEvbD.js";function at(){const i=new FileReader;return i.__zone_symbol__originalInstance||i}class Be{constructor(n){this.fileObj=n,this.fileName=n.name}upload(n,e,p){return k(this,null,function*(){return new Promise((h,F)=>k(this,null,function*(){const l=at(),b=j({url:"hrms.api.upload_base64_file",onSuccess:r=>h(r),onError:r=>{var B;S({title:"Error",text:`File upload failed for ${this.fileName}. ${((B=r.messages)==null?void 0:B[0])||""}`,icon:"alert-circle",position:"bottom-center",iconClasses:"text-red-500"}),F(r)}});l.onload=()=>{console.log("Loaded successfully ✅"),this.fileContents=l.result.toString().split(",")[1],b.submit({content:this.fileContents,dt:n,dn:e,filename:this.fileName,fieldname:p})},l.readAsDataURL(this.fileObj)}))})}delete(){return j({url:"hrms.api.delete_attachment",onSuccess:()=>{console.log("Deleted successfully ✅")},onError:n=>{var e;S({title:"Error",text:`File deletion failed. ${((e=n.messages)==null?void 0:e[0])||""}`,icon:"alert-circle",position:"bottom-center",iconClasses:"text-red-500"})}}).submit({filename:this.fileName})}}const oe=(i,n)=>i.some(e=>n.includes(e));function st(i,n){return k(this,null,function*(){var F;const p=yield j({url:"hrms.api.get_doctype_states",params:{doctype:i}}).reload();if((F=Object.keys(p||{}))!=null&&F.length){if((p==null?void 0:p[n])==="yellow")return"orange";if(p!=null&&p[n])return p==null?void 0:p[n]}let h="gray";return n=n.toLowerCase(),oe(["open","pending","unpaid","review","medium","not approved"],n)?h="orange":oe(["urgent","high","failed","rejected","error"],n)?h="red":oe(["closed","finished","converted","completed","complete","confirmed","approved","yes","active","available","success"],n)?h="green":n==="submitted"&&(h="blue"),h})}function nt(){function i(h){return k(this,arguments,function*({doctype:n,docname:e,filename:p=null}){const F={"X-Frappe-Site-Name":window.location.hostname};window.csrf_token&&(F["X-Frappe-CSRF-Token"]=window.csrf_token),fetch("/api/method/hrms.api._download_pdf",{method:"POST",headers:F,body:new URLSearchParams({doctype:n,docname:e}),responseType:"blob"}).then(l=>{if(l.ok)return l.blob();S({title:"Download Failed",text:"Error downloading PDF",type:"error",icon:"alert-circle",position:"bottom-center",iconClasses:"text-red-500"})}).then(l=>{if(!l)return;const b=window.URL.createObjectURL(l),r=document.createElement("a");r.href=b,r.download=`${p||e}.pdf`,r.click(),setTimeout(()=>{window.URL.revokeObjectURL(b)},3e3)}).catch(l=>{S({title:__("Error"),text:__("Error downloading PDF",[__(l)]),icon:"alert-circle",position:"bottom-center",iconClasses:"text-red-500"})})})}return{downloadPDF:i}}const rt={key:0,class:"flex flex-col h-full w-full"},it={class:"w-full h-full bg-white sm:w-96 flex flex-col"},dt={class:"flex flex-row bg-white shadow-sm py-4 px-3 items-center sticky top-0 z-[1000]"},ut={key:0,class:"flex flex-row items-center gap-2 overflow-hidden grow"},ct={class:"text-xl font-semibold text-gray-900 whitespace-nowrap overflow-hidden text-ellipsis"},mt={key:1,class:"text-2xl font-semibold text-gray-900"},ft={class:"bg-white grow overflow-y-auto"},pt={class:"px-4 sticky top-0 z-[100] bg-white text-sm font-medium text-center text-gray-500 border-b border-gray-200 dark:text-gray-400 dark:border-gray-700"},yt={class:"flex -mb-px overflow-auto hide-scrollbar"},vt={class:"mr-2 whitespace-nowrap"},wt=["onClick"],ht={class:"flex flex-col space-y-4 p-4"},bt={key:0,class:"flex flex-row gap-2 items-center justify-center p-5"},gt={class:"text-gray-900 text-sm"},xt={key:1,class:"flex flex-col space-y-4 p-4"},kt={key:0,class:"flex flex-row gap-2 items-center justify-center p-5"},_t={class:"text-gray-900 text-sm"},Ft={key:0,class:"px-4 pt-4 pb-4 standalone:pb-safe-bottom sm:w-96 bg-white sticky bottom-0 w-full drop-shadow-xl z-40 border-t rounded-t-lg"},Dt={key:2,class:"px-4 pt-4 pb-4 standalone:pb-safe-bottom sm:w-96 bg-white sticky bottom-0 w-full drop-shadow-xl z-40 border-t rounded-t-lg"},Ct={class:"text-xl font-bold"},Vt={class:"font-bold"},St={class:"flex flex-row gap-4"},Bt={class:"text-xl font-bold"},Et={class:"font-bold"},Rt={class:"flex flex-row gap-4"},Ut={class:"text-xl font-bold"},$t={class:"font-bold"},Pt={class:"flex flex-row gap-4"},Tt={__name:"FormView",props:{doctype:{type:String,required:!0},modelValue:{type:Object,required:!0},isSubmittable:{type:Boolean,required:!1,default:!1},fields:{type:Array,required:!0},id:{type:String,required:!1},tabbedView:{type:Boolean,required:!1,default:!1},tabs:{type:Array,required:!1},showAttachmentView:{type:Boolean,required:!1,default:!1},showFormButton:{type:Boolean,required:!1,default:!0},showDownloadPDFButton:{type:Boolean,required:!1,default:!1}},emits:["validateForm","update:modelValue"],setup(i,{emit:n}){var pe;const e=i,p=n,h=Te(),{downloadPDF:F}=nt(),l=We("$translate");let b=C((pe=e.tabs)==null?void 0:pe[0].name),r=C([]),B=C(""),J=C(""),$=C(!1),W=C(!1),D=C(!1),E=C(!1),R=C(!1),H=C(!1),P=C(null);const d=N({get(){return e.modelValue},set(a){p("update:modelValue",a)}}),M=N(()=>{if(!e.id)return"";if(P.value){const a=P.value.getWorkflowStateField();if(a)return d.value[a]}return d.value.status||d.value.approval_status});xe(()=>d.value,()=>{e.id&&(te.value&&!W.value?$.value=!0:W.value&&(W.value=!1))},{deep:!0}),xe(()=>M.value,a=>k(this,null,function*(){a&&(B.value=yield st(e.doctype,M.value))}),{immediate:!0});const Ee=N(()=>{var q;let a={},t=[],x=0,U=0;return(q=e.tabs)==null||q.forEach(O=>{U=e.fields.findIndex(L=>L.fieldname===O.lastField),t=e.fields.slice(x,U+1),a[O.name]=t,x=U+1}),a}),ae=j({url:"hmmhr.api.get_attachments",params:{dt:e.doctype,dn:e.id},transform(a){return a.map(t=>t.uploaded=!0)},onSuccess(a){r.value=a}}),se=a=>{e.id?re(e.doctype,e.id,[...a.target.files]):r.value.push(...a.target.files)},ne=a=>k(this,null,function*(){a.uploaded?(yield new Be(a).delete(),yield ae.reload()):r.value=r.value.filter(t=>t.name!==a.name)});function re(a,t,x){return k(this,null,function*(){H.value=!0;const U=x.map(q=>new Be(q).upload(a,t,"").then(L=>{L.uploaded=!0,e.id&&r.value.push(L)}));yield Promise.allSettled(U),H.value=!1})}const K=He({doctype:e.doctype,insert:{onSuccess(a){return k(this,null,function*(){S({title:l("Success"),text:l("{0} created successfully!",[l(e.doctype)]),icon:"check-circle",position:"bottom-center",iconClasses:"text-green-500"}),yield re(a.doctype,a.name,r.value),h.replace({name:`${e.doctype.replace(/\s+/g,"")}DetailView`,params:{id:a.name}})})},onError(){S({title:l("Error"),text:l("Error creating {0}",[l(e.doctype)]),icon:"alert-circle",position:"bottom-center",iconClasses:"text-red-500"}),console.log(`Error creating ${e.doctype}`)}}}),g=Me({doctype:e.doctype,name:e.id,setValue:{onSuccess(){S({title:l("Success"),text:l("{0} updated successfully!",[l(e.doctype)]),icon:"check-circle",position:"bottom-center",iconClasses:"text-green-500"})},onError(){S({title:l("Error"),text:l("Error updating {0}",[l(e.doctype)]),icon:"alert-circle",position:"bottom-center",iconClasses:"text-red-500"}),console.log(`Error updating ${e.doctype}`)}},delete:{onSuccess(){h.back(),S({title:l("Success"),text:l("{0} deleted successfully!",[l(e.doctype)]),icon:"check-circle",position:"bottom-center",iconClasses:"text-green-500"})},onError(){S({title:l("Error"),text:l("Error deleting {0}",[l(e.doctype)]),icon:"alert-circle",position:"bottom-center",iconClasses:"text-red-500"}),console.log(`Error deleting ${e.doctype}`)}}}),ie=j({url:"frappe.client.get_doc_permissions",params:{doctype:e.doctype,docname:e.id}}),de=j({url:"hmmhr.api.get_permitted_fields_for_write",params:{doctype:e.doctype}}),I=N(()=>{if(e.showFormButton){if(e.id&&e.isSubmittable&&!$.value){if(d.value.docstatus===0&&Q("submit"))return"Submit";if(d.value.docstatus===1&&Q("cancel"))return"Cancel"}else if(d.value.docstatus!==2)return"Save"}});function Re(){return e.id&&d.value.docstatus!==1&&Q("delete")}function Q(a){var t;return(t=ie.data)==null?void 0:t.permissions[a]}function ue(a){var t;return!!a.read_only||ee.value||e.id&&!((t=de.data)!=null&&t.includes(a.fieldname))}function Ue(){ce()&&K.insert.submit(d.value)}function ce(){const a=e.fields.filter(t=>t.reqd&&!t.hidden&&!d.value[t.fieldname]).map(t=>t.label);return a.length?(J.value=`${a.join(", ")} ${a.length>1?"fields are mandatory":"field is mandatory"}`,!1):(J.value="",!0)}function Z(a){return k(this,null,function*(){if(g.doc){let t=Y({},d.value);if(!ce())return;a=="submit"?t.docstatus=1:a=="cancel"&&(t.docstatus=2),yield g.setValue.submit(t),yield g.get.promise,fe()}a==="submit"?E.value=!1:a==="cancel"&&(R.value=!1)})}function $e(){p("validateForm"),e.id?Z():Ue()}function Pe(){$.value||(d.value.docstatus===0?(p("validateForm"),E.value=!0):d.value.docstatus===1&&(R.value=!0))}function qe(){g.delete.submit(),D.value=!1}function me(){return k(this,null,function*(){yield g.reload(),fe()})}function fe(){d.value=Y({},g.doc),et(()=>{$.value=!1,W.value=!0})}function Le(){e.id&&F({doctype:e.doctype,docname:e.id,filename:e.id})}function Ae(){return k(this,null,function*(){const a=yield ot(d.value.company);e.fields.forEach(t=>{t.fieldtype==="Currency"&&(t.readOnly||ee.value)&&(t.options==="currency"?d.value[t.fieldname]=Se(d.value[t.fieldname],d.value.currency):d.value[t.fieldname]=Se(d.value[t.fieldname],a))})})}const ee=N(()=>{var a;if(!te.value)return!0;if(!e.id)return!1;if(d.value.docstatus!==0||(a=P.value)!=null&&a.isReadOnly(d.value))return!0}),te=N(()=>e.id?!g.get.loading&&g.doc:!0);return Xe(()=>k(this,null,function*(){e.id&&(yield g.get.promise,d.value=Y({},g.doc),yield ie.reload(),yield de.reload(),yield ae.reload(),yield Ae(),P.value=tt(e.doctype),$.value=!1)})),(a,t)=>{var U,q,O,L,ye,ve,we,he;const x=Ye("Button");return u(),y(A,null,[te.value?(u(),y("div",rt,[m("div",it,[m("header",dt,[v(x,{variant:"ghost",class:"!pl-0 hover:bg-white",onClick:t[0]||(t[0]=s=>o(h).back())},{default:w(()=>[v(o(Ge),{name:"chevron-left",class:"h-5 w-5"})]),_:1}),i.id?(u(),y("div",ut,[m("h2",ct,f(o(l)(e.doctype)),1),v(o(ke),{label:i.id,class:"whitespace-nowrap text-[8px]",variant:"outline"},null,8,["label"]),M.value?(u(),z(o(ke),{key:0,label:o(l)(M.value,null,i.doctype),theme:o(B),class:"whitespace-nowrap text-[8px]"},null,8,["label","theme"])):T("",!0),v(o(Je),{class:"ml-auto",options:[{label:o(l)("Delete"),condition:Re,onClick:()=>V(D)?D.value=!0:D=!0},{label:o(l)("Reload"),onClick:()=>me()},{label:o(l)("Download PDF"),condition:()=>e.showDownloadPDFButton,onClick:()=>Le()}],button:{label:o(l)("Menu"),icon:"more-horizontal",variant:"ghost"}},null,8,["options","button"])])):(u(),y("h2",mt,f(o(l)("New {0}",[o(l)(i.doctype)],e.doctype)),1))]),m("div",ft,[i.tabbedView?(u(),y(A,{key:0},[m("div",pt,[m("ul",yt,[(u(!0),y(A,null,G(i.tabs,s=>(u(),y("li",vt,[m("button",{onClick:X=>V(b)?b.value=s.name:b=s.name,class:_e(["inline-block py-4 px-2 border-b-2 border-transparent rounded-t-lg",[o(b)===s.name?"!text-gray-800 !border-gray-800":"hover:text-gray-600 hover:border-gray-300"]])},f(o(l)(s.name,null,e.doctype)),11,wt)]))),256))])]),(u(!0),y(A,null,G(Ee.value,(s,X,Oe)=>Ke((u(),y("div",ht,[(u(!0),y(A,null,G(s,c=>(u(),y(A,{key:c.fieldname},[c.fieldtype=="Table"?Fe(a.$slots,c.fieldname,{key:0,isFormReadOnly:ee.value}):(u(),z(Ce,{key:1,fieldtype:c.fieldtype,fieldname:c.fieldname,modelValue:d.value[c.fieldname],"onUpdate:modelValue":Ne=>d.value[c.fieldname]=Ne,default:c.default,label:o(l)(c.label,null,e.doctype),options:c.options,linkFilters:c.linkFilters,documentList:c.documentList,readOnly:ue(c),reqd:!!c.reqd,hidden:!!c.hidden,errorMessage:c.error_message,minDate:c.minDate,maxDate:c.maxDate,addSectionPadding:s[0].name!==c.name},null,8,["fieldtype","fieldname","modelValue","onUpdate:modelValue","default","label","options","linkFilters","documentList","readOnly","reqd","hidden","errorMessage","minDate","maxDate","addSectionPadding"]))],64))),128)),o(H)?(u(),y("div",bt,[v(o(De),{class:"w-3 h-3 text-gray-800"}),m("span",gt,f(o(l)("Uploading...")),1)])):i.showAttachmentView&&Oe===0?(u(),z(Ve,{key:1,modelValue:o(r),"onUpdate:modelValue":t[1]||(t[1]=c=>V(r)?r.value=c:r=c),onHandleFileSelect:se,onHandleFileDelete:ne},null,8,["modelValue"])):T("",!0)],512)),[[Qe,X===o(b)]])),256))],64)):(u(),y("div",xt,[(u(!0),y(A,null,G(e.fields,s=>(u(),z(Ce,{key:s.name,fieldtype:s.fieldtype,fieldname:s.fieldname,modelValue:d.value[s.fieldname],"onUpdate:modelValue":X=>d.value[s.fieldname]=X,default:s.default,label:o(l)(s.label,null,e.doctype),options:s.options,linkFilters:s.linkFilters,documentList:s.documentList,readOnly:ue(s),reqd:!!s.reqd,hidden:!!s.hidden,errorMessage:s.error_message,minDate:s.minDate,maxDate:s.maxDate},null,8,["fieldtype","fieldname","modelValue","onUpdate:modelValue","default","label","options","linkFilters","documentList","readOnly","reqd","hidden","errorMessage","minDate","maxDate"]))),128)),o(H)?(u(),y("div",kt,[v(o(De),{class:"w-3 h-3 text-gray-800"}),m("span",_t,f(o(l)("Uploading...")),1)])):i.showAttachmentView?(u(),z(Ve,{key:1,modelValue:o(r),"onUpdate:modelValue":t[2]||(t[2]=s=>V(r)?r.value=s:r=s),onHandleFileSelect:se,onHandleFileDelete:ne},null,8,["modelValue"])):T("",!0)]))]),i.showFormButton?!o($)&&((U=o(P))!=null&&U.hasWorkflow)?(u(),z(lt,{key:1,doc:o(g).doc,workflow:o(P),onWorkflowApplied:t[3]||(t[3]=s=>me())},null,8,["doc","workflow"])):o($)||!((q=o(P))!=null&&q.hasWorkflow)&&I.value?(u(),y("div",Dt,[v(o(Ze),{class:"mb-2",message:o(J)||((L=(O=o(K))==null?void 0:O.insert)==null?void 0:L.error)||((ve=(ye=o(g))==null?void 0:ye.setValue)==null?void 0:ve.error)},null,8,["message"]),v(x,{class:_e(["w-full rounded py-5 text-base disabled:bg-gray-700 disabled:text-white",I.value==="Cancel"?"shadow":""]),onClick:t[4]||(t[4]=s=>I.value==="Save"?$e():Pe()),variant:I.value==="Cancel"?"subtle":"solid",loading:o(K).insert.loading||((he=(we=o(g))==null?void 0:we.setValue)==null?void 0:he.loading)},{default:w(()=>[_(f(o(l)(I.value)),1)]),_:1},8,["class","variant","loading"])])):T("",!0):(u(),y("div",Ft,[Fe(a.$slots,"formButton")]))])])):T("",!0),v(o(le),{modelValue:o(D),"onUpdate:modelValue":t[6]||(t[6]=s=>V(D)?D.value=s:D=s)},{"body-title":w(()=>[m("h2",Ct,f(o(l)("Delete {0}",[o(l)(e.doctype)])),1)]),"body-content":w(()=>[m("p",null,[_(f(o(l)("Are you sure you want to delete the {0}",[o(l)(e.doctype)]))+" ",1),m("span",Vt,f(d.value.name),1),t[13]||(t[13]=_(" ? "))])]),actions:w(()=>[m("div",St,[v(x,{variant:"outline",class:"py-5 w-full",onClick:t[5]||(t[5]=s=>V(D)?D.value=!1:D=!1)},{default:w(()=>[_(f(o(l)("Cancel")),1)]),_:1}),v(x,{variant:"solid",theme:"red",onClick:qe,class:"py-5 w-full"},{default:w(()=>[_(f(o(l)("Delete")),1)]),_:1})])]),_:1},8,["modelValue"]),v(o(le),{modelValue:o(E),"onUpdate:modelValue":t[9]||(t[9]=s=>V(E)?E.value=s:E=s)},{"body-title":w(()=>[m("h2",Bt,f(o(l)("Confirm")),1)]),"body-content":w(()=>[m("p",null,[_(f(o(l)("Permanently submit {0}",[o(l)(e.doctype)]))+" ",1),m("span",Et,f(d.value.name),1),t[14]||(t[14]=_(" ? "))])]),actions:w(()=>[m("div",Rt,[v(x,{variant:"outline",class:"py-5 w-full",onClick:t[7]||(t[7]=s=>V(E)?E.value=!1:E=!1)},{default:w(()=>[_(f(o(l)("No")),1)]),_:1}),v(x,{variant:"solid",onClick:t[8]||(t[8]=s=>Z("submit")),class:"py-5 w-full"},{default:w(()=>[_(f(o(l)("Yes")),1)]),_:1})])]),_:1},8,["modelValue"]),v(o(le),{modelValue:o(R),"onUpdate:modelValue":t[12]||(t[12]=s=>V(R)?R.value=s:R=s)},{"body-title":w(()=>[m("h2",Ut,f(o(l)("Confirm")),1)]),"body-content":w(()=>[m("p",null,[_(f(o(l)("Permanently cancel {0}",[o(l)(e.doctype)]))+" ",1),m("span",$t,f(d.value.name),1),t[15]||(t[15]=_("? "))])]),actions:w(()=>[m("div",Pt,[v(x,{variant:"outline",class:"py-5 w-full",onClick:t[10]||(t[10]=s=>V(R)?R.value=!1:R=!1)},{default:w(()=>[_(f(o(l)("No")),1)]),_:1}),v(x,{variant:"solid",onClick:t[11]||(t[11]=s=>Z("cancel")),class:"py-5 w-full"},{default:w(()=>[_(f(o(l)("Yes")),1)]),_:1})])]),_:1},8,["modelValue"])],64)}}};export{Tt as default};
//# sourceMappingURL=FormView-Bm8LD5wO.js.map
