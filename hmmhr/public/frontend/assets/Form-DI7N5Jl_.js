import{I as G,a as L}from"./index-CbDAEvbD.js";import{i as A,r as f,c as H,N as y,w as _,z as I,l as i,q as x,j as R,k as F,a3 as J}from"./frappe-ui-XXN5389g.js";import K from"./FormView-Bm8LD5wO.js";import Q from"./ExpensesTable-nWE9RteY.js";import W from"./ExpenseTaxesTable-Beg01CpI.js";import X from"./ExpenseAdvancesTable-Rl_aM2Mf.js";import{g as Z}from"./workflow-B8q7fBbJ.js";import"./FormField-BpF4IXAT.js";import"./Link-DllPwrQU.js";import"./FileUploaderView-BFlUUILK.js";import"./formatters-DKvews8N.js";import"./CustomIonModal-C5puBHWS.js";import"./claims-BcbwDeiX.js";const de={__name:"Form",props:{id:{type:String,required:!1}},setup(w){const D=A("$dayjs")().format("YYYY-MM-DD"),d=f(!1),b=A("$employee"),s=f(b.data.name),E=f(b.data.company),u=w,O=[{name:"Expenses",lastField:"taxes"},{name:"Advances",lastField:"advances"},{name:"Totals",lastField:"cost_center"}],a=f({employee:s,company:E}),h=H(()=>Z(a.value.company)),p=y({url:"hrms.api.get_doctype_fields",params:{doctype:"Expense Claim"},transform(e){return $(e).map(t=>(t.fieldname==="posting_date"&&(t.default=D),S(t)))},onSuccess(e){T.reload(),k.reload()}});p.reload();const V=y({url:"hrms.hr.doctype.expense_claim.expense_claim.get_advances",params:{employee:s.value},auto:!0,onSuccess(e){var n;return u.id?(n=a.value.advances)==null||n.map(t=>t.selected=!0):a.value.advances=[],e.forEach(t=>{var l,o;u.id&&((l=a.value.advances)!=null&&l.some(m=>m.employee_advance===t.name))||(o=a.value.advances)==null||o.push({employee_advance:t.name,purpose:t.purpose,posting_date:t.posting_date,advance_account:t.advance_account,advance_paid:t.paid_amount,unclaimed_amount:t.paid_amount-t.claimed_amount,allocated_amount:0})})}}),T=y({url:"hrms.api.get_expense_approval_details",params:{employee:s.value},onSuccess(e){j(e)}}),k=y({url:"hrms.api.get_company_cost_center_and_expense_account",params:{company:a.value.company},onSuccess(e){a.value.cost_center=e==null?void 0:e.cost_center,a.value.payable_account=e==null?void 0:e.default_expense_claim_payable_account}});_(()=>a.value.employee,e=>{u.id&&e!==s.value&&M(),s.value=e,T.fetch({employee:s.value})}),_(()=>a.value.company,e=>{E.value=e,k.fetch({company:E.value})}),_(()=>u.id&&a.value.expenses,e=>{a.value.docstatus===0&&V.reload()}),_(()=>a.value.advances,e=>{P()},{deep:!0}),_(()=>a.value.cost_center,()=>{var e,n;(n=(e=a==null?void 0:a.value)==null?void 0:e.expenses)==null||n.forEach(t=>{t.cost_center=a.value.cost_center})});function $(e){const n=["naming_series","task","taxes_and_charges_sb","advance_payments_sb"],t=["employee","employee_name","department","company","remark","is_paid","mode_of_payment","clearance_date","approval_status"];return u.id||n.push(...t),e.filter(l=>!n.includes(l.fieldname))}function S(e){return e.fieldname==="payable_account"?e.linkFilters={report_type:"Balance Sheet",account_type:"Payable",company:a.value.company,is_group:0}:e.fieldname==="cost_center"?e.linkFilters={company:a.value.company,is_group:0}:e.fieldname==="project"&&(e.linkFilters={company:a.value.company}),e}function j(e){var t;const n=(t=p.data)==null?void 0:t.find(l=>l.fieldname==="expense_approver");n.reqd=e==null?void 0:e.is_mandatory,n.documentList=e==null?void 0:e.department_approvers.map(l=>({label:l.full_name?`${l.name} : ${l.full_name}`:l.name,value:l.name})),a.value.expense_approver=e==null?void 0:e.expense_approver,a.value.expense_approver_name=e==null?void 0:e.expense_approver_name}function C(e){a.value.expenses||(a.value.expenses=[]),a.value.expenses.push(e),g(),c(),r()}function U(e,n){a.value.expenses[n]=e,g(),c(),r()}function B(e){a.value.expenses.splice(e,1),g(),c(),r()}function Y(e){a.value.taxes||(a.value.taxes=[]),a.value.taxes.push(e),c(),r()}function q(e,n){a.value.taxes[n]=e,c(),r()}function N(e){a.value.taxes.splice(e,1),c(),r()}function g(){var t,l;let e=0,n=0;(l=(t=a.value)==null?void 0:t.expenses)==null||l.forEach(o=>{e+=parseFloat(o.amount),n+=parseFloat(o.sanctioned_amount)}),a.value.total_claimed_amount=e,a.value.total_sanctioned_amount=n,v()}function c(){var n,t;let e=0;(t=(n=a.value)==null?void 0:n.taxes)==null||t.forEach(l=>{l.rate&&(l.tax_amount=parseFloat(a.value.total_sanctioned_amount)*parseFloat(l.rate/100)),l.total=parseFloat(l.tax_amount)+parseFloat(a.value.total_sanctioned_amount),e+=parseFloat(l.tax_amount)}),a.value.total_taxes_and_charges=e,v()}function v(){a.value.grand_total=parseFloat(a.value.total_sanctioned_amount||0)+parseFloat(a.value.total_taxes_and_charges||0)-parseFloat(a.value.total_advance_amount||0)}function r(){var t,l;let e=parseFloat(a.value.total_sanctioned_amount)+parseFloat(a.value.total_taxes_and_charges),n=0;(l=(t=a==null?void 0:a.value)==null?void 0:t.advances)==null||l.forEach(o=>{e>=parseFloat(o.unclaimed_amount)?(o.allocated_amount=parseFloat(o.unclaimed_amount),e-=parseFloat(o.allocated_amount)):(o.allocated_amount=e,e=0),o.selected=o.allocated_amount>0,n+=parseFloat(o.allocated_amount)}),a.value.total_advance_amount=n,v()}function P(){var n,t;let e=0;(t=(n=a==null?void 0:a.value)==null?void 0:n.advances)==null||t.forEach(l=>{l.selected&&(e+=parseFloat(l.allocated_amount))}),a.value.total_advance_amount=e,v()}function M(){u.id&&a.value.expense_approver!==s.value||(p.data.map(e=>e.read_only=!0),d.value=!0)}function z(){var e,n,t,l,o;(e=a==null?void 0:a.value)!=null&&e.advances&&(a.value.advances=(t=(n=a==null?void 0:a.value)==null?void 0:n.advances)==null?void 0:t.filter(m=>m.selected),(o=(l=a==null?void 0:a.value)==null?void 0:l.expenses)==null||o.forEach(m=>{m.cost_center=a.value.cost_center}))}return(e,n)=>(R(),I(x(G),null,{default:i(()=>[F(x(L),{fullscreen:!0},{default:i(()=>[x(p).data?(R(),I(K,{key:0,doctype:"Expense Claim",modelValue:a.value,"onUpdate:modelValue":n[3]||(n[3]=t=>a.value=t),isSubmittable:!0,fields:x(p).data,id:u.id,tabbedView:!0,tabs:O,showAttachmentView:!0,onValidateForm:z,showDownloadPDFButton:!0},{expenses:i(({isFormReadOnly:t})=>[F(Q,{expenseClaim:a.value,"onUpdate:expenseClaim":n[0]||(n[0]=l=>a.value=l),currency:h.value,isReadOnly:d.value||t,onAddExpenseItem:C,onUpdateExpenseItem:U,onDeleteExpenseItem:B},null,8,["expenseClaim","currency","isReadOnly"])]),taxes:i(({isFormReadOnly:t})=>[F(W,{expenseClaim:a.value,"onUpdate:expenseClaim":n[1]||(n[1]=l=>a.value=l),currency:h.value,isReadOnly:d.value||t,onAddExpenseTax:Y,onUpdateExpenseTax:q,onDeleteExpenseTax:N},null,8,["expenseClaim","currency","isReadOnly"])]),advances:i(({isFormReadOnly:t})=>[F(X,{expenseClaim:a.value,"onUpdate:expenseClaim":n[2]||(n[2]=l=>a.value=l),currency:h.value,isReadOnly:d.value||t},null,8,["expenseClaim","currency","isReadOnly"])]),_:1},8,["modelValue","fields","id"])):J("",!0)]),_:1})]),_:1}))}};export{de as default};
//# sourceMappingURL=Form-DI7N5Jl_.js.map
